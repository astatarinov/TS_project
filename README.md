# TS project

### Общее описание

В рамках проекта реализован автоматизированный пайплайн обучения модели для прогнозирования сальдо показателя, связанного с потоками ликвидности.
Пайплайн содержит в себе следующие стадии: запуск процесса дообучения, формирование датасета, формирование признакового пространства, отбор признаков, подбор гиперпараметров, обучение модели, валидация модели, проверка на удовлетворение бизнес метрикам. 

Для запуска модели предусмотрен cron-job ежедневного дообучения (файл `run.py`), а также демонстрацинный jupyter-ноутбук (файл `notebooks/demo.ipynb`)

### Структура проекта

```
.
├── README.md
├── ToDo.md
├── datasets                            
│   ├── balances.csv                        исходный файл, предоставленный в задании
│   ├── cbr_rate.csv                        данные о ключевой ставке
│   ├── custom_calendar.csv                 данные из производственного календаря
│   ├── extended_data.csv                   финальный датасет со всеми фичами
│   ├── mosprime.csv                        индикатор mosprime 
│   ├── raw_data.xlsx                       исходные xlsx
│   ├── tsfresh_features.csv                излеченные признаки tsfresh
│   └── usd_xr.csv                          данные об обменном курсе
├── demo.ipynb                              !ДЕМО ноутбук, где демонстрируем работу всего пайплайна!
├── notebooks
│   ├── mutual_info_fs.ipynb                отбор признаков методом взаимной информации
│   ├── autoregression.ipynb                ноутбук с исследованием авторегрессионных моделей
│   ├── baseline.ipynb                      обучение предсказательной модели
│   ├── baseline_tsfresh.ipynb              обучение предсказательной модели с признаками tsfresh
│   ├── build_dataset.ipynb                 сбор датасета
│   ├── eda.ipynb                           ислледование данных
│   ├── process_raw_data.ipynb              предобработка данных
│   ├── tsfresh_features.ipynb              извлечение признаков с помощью tsfresh
│   └── tune_changepoint_detection.ipynb    подбор гиперпараметров для моделей детекции разладки
├── project
│   ├── config.py                           конфиги для предсказательной модели и модели для разладок
│   ├── kliep.py                            модель детекции разладок
│   ├── model                               предсказательная модель
│   ├── pipeline.py                         полный пайплайн 
│   └── utils                               модуль вспомогательных функций
├── requirements.txt 
└── run.py                                  ПРОМ решение для цикличного запуска модели
```

### Данные

Для формирования датасета, помимо показателей притока, оттока и сальдо, были добавлены внешние признаки в целях формирования признакового пространства, описывающего коньюктуру рынка, а также косвенно поведение его агентов.

Среди них:
- ключевая ставка ЦБ
- российский календарь праздничных и нерабочих дней
- индикатор MOSPRIME, рассчитанный на разные временные горизонты
- обменный курс доллара

Таким образом, был сформирован 51 признак.

### Отбор признаков

Для формирования расширенного признакового пространства были протестированы следующие подходы:

1. Использовали sklearn.mutual_info_regression для отбора значимых признаков методом взаимной информации. Проверили **стабильность** отбора признаков на подвыборках методом бутстрапа (cм. `notebooks/mutual_info_fs.ipynb`).

2. Была использована библиотека `tsfresh` для генерации и отбора признаков (лаги, средние и др.). С помощью данного решения удалось сгенерировать множество фичей, из которых были отобраны только значимые – 354 штуки. Для этого проводился тест на значимость каждого фактора, незначимые признаки были отфильтрованы (cм. `notebooks/tsfresh_features.ipynb`).

### Модель детекции разладок

В качестве модели для детекции разладки вы взяли KLIEP (Kullback-Leibler importance estimation procedure).  

Код для данного метода (реализация) сделана нами целиком в файле `./project/kliep.py` (он содержит реализацию подсчета статистик, функцию для обучения и функцию для предикта).
Детекцию разладок производили отдельно для рядов income и outcome.

Для обучения модели мы разметили часть данных из рядов и подобрали гиперпараметры. В подробностях с этим можно ознакомиться в `./notebooks/tune_changepoint_detection.ipynb`

### Модель прогнозирования

В рамках проекта были исследованы 2 архитектуры модели.

1. Авторегрессионные модели

Результат исследования на применимость: ряд balance слабо стационарен in levels, income и outcome стационарны в первых разностях. Таким образом, можем использовать ARIMA с 0 и 1 разностью соответственно.

Стационарность проверялась с помощью теста Дики-Фуллера.

Выявили значимость лагов кратных 7, использовали их в дальнейшем в нелинейных моделях. Годовая и месячная сезонность не выявлены.

В рамках данного класса моделей обучили SARIMA, SARIMAX для всех 3х рядов.  

Результаты и детали подробно описаны в ноутбуке `notebooks/autoregression.ipynb`. 

2. Бустинг (CatBoost)

Для обучения данной архитектуры гиперпараметры подбирали с помощью метода GridSearch по кросс-валидации. Лучшую модель обучили на всех доступных для обучения данных.

Для удовлеторения требованиям заказчика был выбран Huber-loss с параметром 0.42 в качестве лосс-функции. Таким образом, модель линейно штрафует за ошибки менее 0.42 и квадратично в противном случае.

Результаты и детали подробно описаны в ноутбуке `notebooks/baseline.ipynb` и `notebooks/baseline_tsfresh.ipynb` (обучение на расширенном признаковом пространстве, полученном с помощью `tsfresh`).

### Бизнес-метрика

Была предложена метрика оценки экономической эффективности в виде дополнительной маржи, зарабатываемой благодаря использованию предсказаний модели. Данная оценка вычисляет фактический финансовый результат в предположении, что при предсказанном профиците средства размещаются в деривативы, за вычетом альтернативы в виде размещения overnight.

Реализация: `project/utils/metrics.py::calculate_add_margin`

### Результаты

В результате работы удалось построить пайплайн обучения, включающий в себя отбор признаков, модель детекции разладок, предсказательную модель, валидацию, а также ПРОМ-решение для периодического запуска дообучения.

Была посчитана экономическая эффективность (дополнительная маржа за счет предсказаний) построенной модели в процессе бэктестирования.

**Полученные предсказания удовлетворяют требованиям бизнеса, поскольку соответствуют ограничению на максимальное отклонение в 0.42.**
